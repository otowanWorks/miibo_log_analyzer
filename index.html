<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">

    <title>miiboãƒ­ã‚°åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
:root {
  --primary-color: #10b981;
  --primary-hover: #059669;
  --secondary-color: #6b7280;
  --accent-color: #3b82f6;
  --success-color: #22c55e;
  --warning-color: #f59e0b;
  --error-color: #ef4444;
  --bg-color: #f9fafb;
  --card-bg: #ffffff;
  --border-color: #e5e7eb;
  --text-color: #111827;
  --text-secondary: #6b7280;
  --border-radius: 12px;
  --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
  --transition: all 0.3s ease;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Noto Sans JP', sans-serif;
  background-color: var(--bg-color);
  color: var(--text-color);
  line-height: 1.6;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
.header {
  background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
  color: white;
  padding: 30px;
  border-radius: var(--border-radius);
  margin-bottom: 30px;
  text-align: center;
  box-shadow: var(--box-shadow);
}

.header h1 {
  font-size: 2.5rem;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
}

.header p {
  font-size: 1.1rem;
  opacity: 0.9;
}

.miibo-icon {
  background: rgba(255, 255, 255, 0.2);
  padding: 12px;
  border-radius: 50%;
  font-size: 1.8rem;
}

/* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
.upload-section {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 30px;
  margin-bottom: 30px;
  box-shadow: var(--box-shadow);
  border: 2px dashed var(--border-color);
  transition: var(--transition);
}

.upload-section.dragover {
  border-color: var(--primary-color);
  background: rgba(16, 185, 129, 0.05);
}

.upload-area {
  text-align: center;
  padding: 20px;
}

.upload-area input[type="file"] {
  display: none;
}

.upload-btn {
  background: var(--primary-color);
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: 8px;
  font-size: 1.1rem;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 10px;
}

.upload-btn:hover {
  background: var(--primary-hover);
  transform: translateY(-2px);
}

.file-info {
  margin-top: 15px;
  font-size: 0.9rem;
  color: var(--text-secondary);
}

/* æœŸé–“é¸æŠ */
.period-controls {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.period-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.period-group label {
  font-weight: 500;
  color: var(--text-color);
}

.period-group input {
  padding: 10px;
  border: 2px solid var(--border-color);
  border-radius: 6px;
  font-size: 1rem;
  transition: var(--transition);
}

.period-group input:focus {
  border-color: var(--primary-color);
  outline: none;
}

.compare-btn {
  background: var(--accent-color);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
}

.compare-btn:hover {
  background: #2563eb;
}

.compare-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 25px;
  box-shadow: var(--box-shadow);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.stat-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--primary-color);
}

.stat-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 15px;
}

.stat-title {
  font-size: 0.9rem;
  color: var(--text-secondary);
  font-weight: 500;
}

.stat-icon {
  color: var(--primary-color);
  font-size: 1.2rem;
}

.stat-value {
  font-size: 2.2rem;
  font-weight: 700;
  color: var(--text-color);
  margin-bottom: 5px;
}

.stat-change {
  font-size: 0.85rem;
  font-weight: 500;
}

.stat-change.positive {
  color: var(--success-color);
}

.stat-change.negative {
  color: var(--error-color);
}

.stat-change.neutral {
  color: var(--text-secondary);
}

/* ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ */
.charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 30px;
  margin-bottom: 30px;
}

.chart-card {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 25px;
  box-shadow: var(--box-shadow);
}

.chart-title {
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--text-color);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.chart-container {
  position: relative;
  height: 300px;
}

.chart-container canvas {
  max-height: 100%;
}

/* ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.export-section {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 25px;
  box-shadow: var(--box-shadow);
  text-align: center;
}

.export-buttons {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 15px;
}

.export-btn {
  background: var(--secondary-color);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 8px;
}

.export-btn:hover {
  background: #4b5563;
  transform: translateY(-1px);
}

.export-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
.loading {
  display: none;
  text-align: center;
  padding: 40px;
  color: var(--text-secondary);
}

.loading.show {
  display: block;
}

.spinner {
  display: inline-block;
  width: 40px;
  height: 40px;
  border: 3px solid var(--border-color);
  border-radius: 50%;
  border-top-color: var(--primary-color);
  animation: spin 1s ease-in-out infinite;
  margin-bottom: 15px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
.error-message {
  background: #fef2f2;
  border: 1px solid #fecaca;
  color: #b91c1c;
  padding: 15px;
  border-radius: 8px;
  margin: 15px 0;
  display: none;
}

.success-message {
  background: #f0fdf4;
  border: 1px solid #bbf7d0;
  color: #166534;
  padding: 15px;
  border-radius: 8px;
  margin: 15px 0;
  display: none;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
@media (max-width: 768px) {
  .container {
    padding: 15px;
  }
  
  .header h1 {
    font-size: 2rem;
    flex-direction: column;
  }
  
  .charts-grid {
    grid-template-columns: 1fr;
  }
  
  .chart-container {
    height: 250px;
  }
  
  .export-buttons {
    flex-direction: column;
    align-items: center;
  }
  
  .period-controls {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .stat-value {
    font-size: 1.8rem;
  }
}

/* ä¼šè©±å†…å®¹åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.content-analysis-section {
  margin: 30px 0;
}

.section-header {
  text-align: center;
  margin-bottom: 30px;
  padding: 20px;
  background: var(--card-bg);
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
}

.section-header h2 {
  font-size: 2rem;
  color: var(--primary-color);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
}

.section-header p {
  color: var(--text-secondary);
  font-size: 1.1rem;
}

.content-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 25px;
}

.content-card {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 25px;
  box-shadow: var(--box-shadow);
  transition: var(--transition);
}

.content-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.content-card.full-width {
  grid-column: 1 / -1;
}

.content-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--text-color);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 2px solid var(--border-color);
  padding-bottom: 10px;
}

.content-title i {
  color: var(--primary-color);
}

/* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆ */
.ranking-list {
  max-height: 300px;
  overflow-y: auto;
}

.ranking-item {
  display: flex;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--border-color);
  transition: var(--transition);
}

.ranking-item:last-child {
  border-bottom: none;
}

.ranking-item:hover {
  background: var(--bg-color);
  margin: 0 -15px;
  padding-left: 15px;
  padding-right: 15px;
  border-radius: 6px;
}

.ranking-number {
  background: var(--primary-color);
  color: white;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 0.9rem;
  margin-right: 15px;
  flex-shrink: 0;
}

.ranking-number.top3 {
  background: linear-gradient(45deg, #ffd700, #ffed4e);
  color: #92400e;
}

.ranking-text {
  flex: 1;
  font-size: 0.95rem;
  color: var(--text-color);
  margin-right: 10px;
  word-break: break-all;
}

.ranking-count {
  background: var(--bg-color);
  color: var(--text-secondary);
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 500;
}

/* ãƒ†ã‚­ã‚¹ãƒˆçµ±è¨ˆ */
.text-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 15px;
}

.text-stat-item {
  text-align: center;
  padding: 15px;
  background: var(--bg-color);
  border-radius: 8px;
  border: 1px solid var(--border-color);
}

.text-stat-value {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--primary-color);
  margin-bottom: 5px;
}

.text-stat-label {
  font-size: 0.85rem;
  color: var(--text-secondary);
  font-weight: 500;
}

/* æ„Ÿæƒ…åˆ†æã‚°ãƒªãƒƒãƒ‰ */
.emotion-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}

.emotion-item {
  text-align: center;
  padding: 20px;
  background: var(--bg-color);
  border-radius: 8px;
  border: 1px solid var(--border-color);
  transition: var(--transition);
}

.emotion-item:hover {
  border-color: var(--primary-color);
  transform: translateY(-2px);
}

.emotion-icon {
  font-size: 2.5rem;
  margin-bottom: 10px;
  display: block;
}

.emotion-label {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-color);
  margin-bottom: 8px;
}

.emotion-count {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--primary-color);
  margin-bottom: 5px;
}

.emotion-percentage {
  font-size: 0.85rem;
  color: var(--text-secondary);
}
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="header">
            <h1>
                <div class="miibo-icon">
                    <i class="fas fa-robot"></i>
                </div>
                miiboãƒ­ã‚°åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
            </h1>
            <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•ã¨ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã‚’åˆ†æã—ã¾ã—ã‚‡ã†</p>
        </header>

        <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
        <section class="upload-section" id="uploadSection">
            <div class="upload-area">
                <input type="file" id="csvFile" accept=".csv" />
                <button class="upload-btn" onclick="document.getElementById('csvFile').click()">
                    <i class="fas fa-upload"></i>
                    CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                </button>
                <div class="file-info" id="fileInfo">
                    CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ä¸Šã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„
                </div>
            </div>
            
            <!-- æœŸé–“é¸æŠ -->
            <div class="period-controls" id="periodControls" style="display: none;">
                <div class="period-group">
                    <label for="startDate1">æœŸé–“1 é–‹å§‹æ—¥</label>
                    <input type="date" id="startDate1" />
                </div>
                <div class="period-group">
                    <label for="endDate1">æœŸé–“1 çµ‚äº†æ—¥</label>
                    <input type="date" id="endDate1" />
                </div>
                <div class="period-group">
                    <label for="startDate2">æœŸé–“2 é–‹å§‹æ—¥</label>
                    <input type="date" id="startDate2" />
                </div>
                <div class="period-group">
                    <label for="endDate2">æœŸé–“2 çµ‚äº†æ—¥</label>
                    <input type="date" id="endDate2" />
                </div>
                <div class="period-group">
                    <button class="compare-btn" id="compareBtn" onclick="comparePeriods()">
                        <i class="fas fa-chart-line"></i>
                        æœŸé–“æ¯”è¼ƒå®Ÿè¡Œ
                    </button>
                </div>
                <div class="period-group">
                    <button class="reset-btn" id="resetBtn" onclick="resetToInitialView()">
                        <i class="fas fa-undo"></i>
                        åˆæœŸè¡¨ç¤ºã«ãƒªã‚»ãƒƒãƒˆ
                    </button>
                </div>
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            <div class="data-warning" id="dataWarning">
                <div id="warningContent"></div>
                <div class="warning-actions" id="warningActions"></div>
            </div>
            <div class="progress-bar-container" id="progressContainer">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText"></div>
            </div>
            <div class="performance-info" id="performanceInfo"></div>
        </section>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
        </div>

        <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
        <section class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°</span>
                    <i class="fas fa-comments stat-icon"></i>
                </div>
                <div class="stat-value" id="totalMessages">0</div>
                <div class="stat-change" id="totalMessagesChange"></div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</span>
                    <i class="fas fa-users stat-icon"></i>
                </div>
                <div class="stat-value" id="uniqueUsers">0</div>
                <div class="stat-change" id="uniqueUsersChange"></div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">å¹³å‡ã‚»ãƒƒã‚·ãƒ§ãƒ³é•·</span>
                    <i class="fas fa-clock stat-icon"></i>
                </div>
                <div class="stat-value" id="avgSessionLength">0</div>
                <div class="stat-change" id="avgSessionLengthChange"></div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">æ´»å‹•æœŸé–“</span>
                    <i class="fas fa-calendar stat-icon"></i>
                </div>
                <div class="stat-value" id="activityPeriod">-</div>
                <div class="stat-change" id="activityPeriodChange"></div>
            </div>
        </section>

        <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
        <section class="charts-grid" id="chartsGrid" style="display: none;">
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    æ™‚ç³»åˆ—ãƒˆãƒ¬ãƒ³ãƒ‰
                </h3>
                <div class="chart-container">
                    <canvas id="timeSeriesChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-th"></i>
                    æ™‚é–“å¸¯ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—
                </h3>
                <div class="chart-container">
                    <canvas id="heatmapChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ¯”è¼ƒ
                </h3>
                <div class="chart-container">
                    <canvas id="platformChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-chart-bar"></i>
                    ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†å¸ƒ
                </h3>
                <div class="chart-container">
                    <canvas id="sessionChart"></canvas>
                </div>
            </div>
        </section>

        <!-- ä¼šè©±å†…å®¹åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section class="content-analysis-section" id="contentAnalysisSection" style="display: none;">
            <div class="section-header">
                <h2>
                    <i class="fas fa-comments"></i>
                    ä¼šè©±å†…å®¹åˆ†æ
                </h2>
                <p>ç™ºè©±å†…å®¹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é–¢å¿ƒäº‹ã‚’åˆ†æã—ã¾ã™</p>
            </div>
            
            <div class="content-grid">
                <!-- ç™ºè©±é »åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
                <div class="content-card">
                    <h3 class="content-title">
                        <i class="fas fa-trophy"></i>
                        ã‚ˆãã‚ã‚‹ç™ºè©± TOP10
                    </h3>
                    <div class="ranking-list" id="utteranceRanking">
                        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æ -->
                <div class="content-card">
                    <h3 class="content-title">
                        <i class="fas fa-tags"></i>
                        ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é »åº¦åˆ†æ
                    </h3>
                    <div class="chart-container">
                        <canvas id="keywordChart"></canvas>
                    </div>
                </div>

                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ -->
                <div class="content-card">
                    <h3 class="content-title">
                        <i class="fas fa-user-friends"></i>
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³
                    </h3>
                    <div class="chart-container">
                        <canvas id="behaviorChart"></canvas>
                    </div>
                </div>

                <!-- æ–‡å­—æ•°åˆ†æ -->
                <div class="content-card">
                    <h3 class="content-title">
                        <i class="fas fa-text-width"></i>
                        ç™ºè©±æ–‡å­—æ•°åˆ†æ
                    </h3>
                    <div class="text-stats" id="textStats">
                        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- æ„Ÿæƒ…ãƒ»æ„å›³åˆ†æ -->
                <div class="content-card full-width">
                    <h3 class="content-title">
                        <i class="fas fa-heart"></i>
                        æ„Ÿæƒ…ãƒ»æ„å›³åˆ†æ
                    </h3>
                    <div class="emotion-grid" id="emotionAnalysis">
                        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </section>

        <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section class="export-section" id="exportSection" style="display: none;">
            <h3>
                <i class="fas fa-download"></i>
                åˆ†æçµæœã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </h3>
            <p>åˆ†æã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™</p>
            <div class="export-buttons">
                <button class="export-btn" id="exportStatsBtn" onclick="exportStats()">
                    <i class="fas fa-table"></i>
                    çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’CSVå‡ºåŠ›
                </button>
                <button class="export-btn" id="exportTimeSeriesBtn" onclick="exportTimeSeries()">
                    <i class="fas fa-chart-line"></i>
                    æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’CSVå‡ºåŠ›
                </button>
                <button class="export-btn" id="exportContentBtn" onclick="exportContentAnalysis()">
                    <i class="fas fa-comments"></i>
                    ä¼šè©±å†…å®¹åˆ†æã‚’CSVå‡ºåŠ›
                </button>
            </div>
        </section>

        <!-- ãƒ‡ãƒ¼ã‚¿ãªã—çŠ¶æ…‹ -->
        <div class="no-data" id="noData">
            <i class="fas fa-chart-bar"></i>
            <h3>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</h3>
            <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€åˆ†æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentData = null;
        let period1Data = null;
        let period2Data = null;
        let charts = {
            timeSeries: null,
            heatmap: null,
            platform: null,
            session: null,
            keyword: null,
            behavior: null
        };

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload();
            setupDragAndDrop();
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¨­å®š
        function setupFileUpload() {
            const fileInput = document.getElementById('csvFile');
            fileInput.addEventListener('change', handleFileSelect);
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
        function setupDragAndDrop() {
            const uploadSection = document.getElementById('uploadSection');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadSection.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadSection.addEventListener(eventName, () => {
                    uploadSection.classList.add('dragover');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadSection.addEventListener(eventName, () => {
                    uploadSection.classList.remove('dragover');
                }, false);
            });

            uploadSection.addEventListener('drop', handleDrop, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ï¼ˆä¿®æ­£ç‰ˆï¼‰
        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showError('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
            const sizeMB = file.size / (1024 * 1024);
            if (sizeMB > 50) {
                showError(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ${sizeMB.toFixed(1)}MBï¼‰ã€‚50MBä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚`);
                return;
            }

            showLoading(true);
            if (sizeMB > 10) {
                showProgress(0, 'å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ä¸­...');
            }
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        showError('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
                        hideProgress();
                        showLoading(false);
                        return;
                    }
                    
                    const recordCount = results.data.length;
                    
                    // ãƒ‡ãƒ¼ã‚¿é‡ãƒã‚§ãƒƒã‚¯ã¨è­¦å‘Šè¡¨ç¤º
                    if (recordCount > 50000) {
                        hideProgress();
                        showLoading(false);
                        showCriticalWarning(recordCount, results.data, file.name);
                        return;
                    } else if (recordCount > 15000) {
                        showDataSizeWarning('heavy', recordCount);
                    } else if (recordCount > 5000) {
                        showDataSizeWarning('medium', recordCount);
                    }
                    
                    // å‡¦ç†å®Ÿè¡Œ
                    executeDataProcessing(results.data, file.name, recordCount);
                },
                error: function() {
                    showError('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    hideProgress();
                    showLoading(false);
                }
            });
        }

        // ãƒ‡ãƒ¼ã‚¿å‡¦ç†å®Ÿè¡Œ
        function executeDataProcessing(data, filename, recordCount) {
            try {
                if (recordCount > 10000) {
                    showProgress(50, 'ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...');
                }
                
                currentData = data;
                updateFileInfo(filename, currentData.length);
                
                if (recordCount > 10000) {
                    showProgress(70, 'æœŸé–“è¨­å®šã‚’æº–å‚™ä¸­...');
                }
                
                setupPeriodControls();
                
                if (recordCount > 10000) {
                    showProgress(90, 'ã‚°ãƒ©ãƒ•ã‚’ä½œæˆä¸­...');
                }
                
                analyzeData();
                
                // å¿…ãšå®Œäº†å‡¦ç†ã‚’å®Ÿè¡Œ
                hideProgress();
                showLoading(false);
                showSuccess(`${currentData.length.toLocaleString()}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                
                // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æƒ…å ±ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
                if (recordCount > 5000) {
                    setTimeout(() => {
                        showPerformanceInfo(recordCount);
                    }, 1000);
                }
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                hideProgress();
                showLoading(false);
                showError('ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºè­¦å‘Šè¡¨ç¤ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function showDataSizeWarning(level, recordCount) {
            let message = '';
            
            if (level === 'heavy') {
                message = `âš ï¸ å¤§å®¹é‡ãƒ‡ãƒ¼ã‚¿: ${recordCount.toLocaleString()}ä»¶ - å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™`;
            } else if (level === 'medium') {
                message = `â„¹ï¸ ã‚„ã‚„å¤§ããªãƒ‡ãƒ¼ã‚¿: ${recordCount.toLocaleString()}ä»¶ - é€šå¸¸ã‚ˆã‚Šæ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™`;
            }
            
            if (message) {
                const performanceEl = document.getElementById('performanceInfo');
                performanceEl.textContent = message;
                performanceEl.classList.add('show');
                
                setTimeout(() => {
                    performanceEl.classList.remove('show');
                }, 4000);
            }
        }

        // å±é™ºãƒ¬ãƒ™ãƒ«ã®è­¦å‘Šï¼ˆ50,000ä»¶ä»¥ä¸Šï¼‰
        function showCriticalWarning(recordCount, data, filename) {
            const warningEl = document.getElementById('dataWarning');
            const contentEl = document.getElementById('warningContent');
            const actionsEl = document.getElementById('warningActions');
            
            warningEl.className = 'data-warning critical show';
            
            contentEl.innerHTML = `
                <strong>ğŸš¨ ãƒ‡ãƒ¼ã‚¿é‡ãŒéå¸¸ã«å¤šã„ã§ã™</strong><br>
                ${recordCount.toLocaleString()}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚<br>
                ãƒ–ãƒ©ã‚¦ã‚¶ã®å‹•ä½œãŒé‡ããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚<br><br>
                <strong>æ¨å¥¨äº‹é …:</strong><br>
                â€¢ æœŸé–“ã‚’åˆ†å‰²ã—ã¦å°ã•ãªãƒ•ã‚¡ã‚¤ãƒ«ã«ã—ã¦ãã ã•ã„<br>
                â€¢ æ¨å¥¨ãƒ‡ãƒ¼ã‚¿é‡: 5,000ä»¶ä»¥ä¸‹/æœˆ
            `;
            
            actionsEl.innerHTML = `
                <button class="warning-btn" onclick="forceProcessData('${filename}', ${recordCount})">
                    ğŸš€ ã“ã®ã¾ã¾ç¶šè¡Œï¼ˆå±é™ºï¼‰
                </button>
                <button class="warning-btn" onclick="cancelProcessing()">
                    âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            `;
        }

        // å¼·åˆ¶å‡¦ç†
        function forceProcessData(filename, recordCount) {
            hideDataWarning();
            showLoading(true);
            showProgress(0, 'å¤§å®¹é‡ãƒ‡ãƒ¼ã‚¿ã‚’å¼·åˆ¶å‡¦ç†ä¸­...');
            
            // å°‘ã—é…å»¶ã•ã›ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«çŠ¶æ³ã‚’ç†è§£ã—ã¦ã‚‚ã‚‰ã†
            setTimeout(() => {
                executeDataProcessing(currentData, filename, recordCount);
            }, 500);
        }

        // å‡¦ç†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelProcessing() {
            hideDataWarning();
            document.getElementById('csvFile').value = '';
            currentData = null;
        }

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æƒ…å ±è¡¨ç¤ºï¼ˆç°¡ç•¥ç‰ˆï¼‰
        function showPerformanceInfo(recordCount) {
            const performanceEl = document.getElementById('performanceInfo');
            
            if (recordCount > 15000) {
                performanceEl.textContent = `ğŸ’¡ ${recordCount.toLocaleString()}ä»¶ã®å¤§å®¹é‡ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚ã‚°ãƒ©ãƒ•è¡¨ç¤ºã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚`;
            } else if (recordCount > 5000) {
                performanceEl.textContent = `ğŸ’¡ ${recordCount.toLocaleString()}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¾ã—ãŸã€‚`;
            }
            
            performanceEl.classList.add('show');
            
            setTimeout(() => {
                performanceEl.classList.remove('show');
            }, 3000);
        }

        // é€²æ—è¡¨ç¤ºï¼ˆç°¡ç•¥ç‰ˆï¼‰
        function showProgress(percentage, message) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (progressContainer && progressFill && progressText) {
                progressContainer.classList.add('show');
                progressFill.style.width = `${Math.min(percentage, 100)}%`;
                progressText.textContent = message;
            }
        }

        // é€²æ—éè¡¨ç¤º
        function hideProgress() {
            const progressContainer = document.getElementById('progressContainer');
            if (progressContainer) {
                progressContainer.classList.remove('show');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿è­¦å‘Šéè¡¨ç¤º
        function hideDataWarning() {
            const warningEl = document.getElementById('dataWarning');
            if (warningEl) {
                warningEl.className = 'data-warning';
            }
        }

        // æœŸé–“é¸æŠã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¨­å®š
        function setupPeriodControls() {
            if (!currentData || currentData.length === 0) return;

            const dates = currentData
                .map(row => new Date(row.utterance_date))
                .filter(date => !isNaN(date));
            
            if (dates.length === 0) return;

            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            
            const startDate1 = document.getElementById('startDate1');
            const endDate1 = document.getElementById('endDate1');
            const startDate2 = document.getElementById('startDate2');
            const endDate2 = document.getElementById('endDate2');
            
            const formatDate = (date) => date.toISOString().split('T')[0];
            
            // åˆæœŸå€¤ã‚’è¨­å®šï¼ˆãƒ‡ãƒ¼ã‚¿ç¯„å›²ã®å‰åŠã¨å¾ŒåŠã«åˆ†å‰²ï¼‰
            const initialStartDate1 = formatDate(minDate);
            const initialEndDate1 = formatDate(new Date(minDate.getTime() + (maxDate - minDate) / 2));
            const initialStartDate2 = formatDate(new Date(minDate.getTime() + (maxDate - minDate) / 2));
            const initialEndDate2 = formatDate(maxDate);
            
            startDate1.value = initialStartDate1;
            endDate1.value = initialEndDate1;
            startDate2.value = initialStartDate2;
            endDate2.value = initialEndDate2;
            
            // åˆæœŸå€¤ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ï¼ˆãƒªã‚»ãƒƒãƒˆç”¨ï¼‰
            window.initialPeriodDates = {
                startDate1: initialStartDate1,
                endDate1: initialEndDate1,
                startDate2: initialStartDate2,
                endDate2: initialEndDate2
            };
            
            document.getElementById('periodControls').style.display = 'grid';
        }

        // ãƒ‡ãƒ¼ã‚¿åˆ†æ
        function analyzeData(data = currentData) {
            if (!data) return;

            try {
                const stats = calculateStats(data);
                updateStatsDisplay(stats);
                createCharts(data);
                analyzeContent(data);
                showSections();
            } catch (error) {
                console.error('åˆ†æã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ‡ãƒ¼ã‚¿åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // çµ±è¨ˆè¨ˆç®—
        function calculateStats(data) {
            const totalMessages = data.length;
            
            const uniqueUsers = new Set(
                data.map(row => row.user_uid).filter(Boolean)
            ).size;
            
            const sessions = {};
            data.forEach(row => {
                if (row.session_id) {
                    sessions[row.session_id] = (sessions[row.session_id] || 0) + 1;
                }
            });
            
            const sessionLengths = Object.values(sessions);
            const avgSessionLength = sessionLengths.length > 0 
                ? (sessionLengths.reduce((a, b) => a + b, 0) / sessionLengths.length).toFixed(1)
                : 0;
            
            const dates = data
                .map(row => new Date(row.utterance_date))
                .filter(date => !isNaN(date));
            
            let activityPeriod = '-';
            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                const days = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1;
                activityPeriod = `${days}æ—¥`;
            }
            
            return {
                totalMessages,
                uniqueUsers,
                avgSessionLength,
                activityPeriod,
                sessions,
                dates
            };
        }

        // çµ±è¨ˆè¡¨ç¤ºæ›´æ–°
        function updateStatsDisplay(stats, compareStats = null) {
            document.getElementById('totalMessages').textContent = stats.totalMessages.toLocaleString();
            document.getElementById('uniqueUsers').textContent = stats.uniqueUsers.toLocaleString();
            document.getElementById('avgSessionLength').textContent = stats.avgSessionLength;
            document.getElementById('activityPeriod').textContent = stats.activityPeriod;
            
            if (compareStats) {
                updateChangeIndicators(stats, compareStats);
            } else {
                clearChangeIndicators();
            }
        }

        // å¤‰åŒ–æŒ‡æ¨™æ›´æ–°
        function updateChangeIndicators(current, previous) {
            updateChange('totalMessagesChange', current.totalMessages, previous.totalMessages);
            updateChange('uniqueUsersChange', current.uniqueUsers, previous.uniqueUsers);
            updateChange('avgSessionLengthChange', parseFloat(current.avgSessionLength), parseFloat(previous.avgSessionLength));
        }

        function updateChange(elementId, current, previous) {
            const element = document.getElementById(elementId);
            if (previous === 0) {
                element.textContent = '';
                element.className = 'stat-change neutral';
                return;
            }
            
            const change = ((current - previous) / previous * 100).toFixed(1);
            const isPositive = current > previous;
            
            element.textContent = `${isPositive ? '+' : ''}${change}%`;
            element.className = `stat-change ${isPositive ? 'positive' : (current < previous ? 'negative' : 'neutral')}`;
        }

        function clearChangeIndicators() {
            ['totalMessagesChange', 'uniqueUsersChange', 'avgSessionLengthChange', 'activityPeriodChange'].forEach(id => {
                const element = document.getElementById(id);
                element.textContent = '';
                element.className = 'stat-change neutral';
            });
        }

        // ã‚°ãƒ©ãƒ•ä½œæˆ
        function createCharts(data) {
            createTimeSeriesChart(data);
            createHeatmapChart(data);
            createPlatformChart(data);
            createSessionChart(data);
        }

        // æ™‚ç³»åˆ—ã‚°ãƒ©ãƒ•
        function createTimeSeriesChart(data) {
            const ctx = document.getElementById('timeSeriesChart');
            
            if (charts.timeSeries) {
                charts.timeSeries.destroy();
            }
            
            const dailyStats = {};
            data.forEach(row => {
                const date = new Date(row.utterance_date);
                if (!isNaN(date)) {
                    const dateKey = date.toISOString().split('T')[0];
                    dailyStats[dateKey] = (dailyStats[dateKey] || 0) + 1;
                }
            });
            
            const sortedDates = Object.keys(dailyStats).sort();
            const values = sortedDates.map(date => dailyStats[date]);
            
            charts.timeSeries = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates.map(date => new Date(date).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°',
                        data: values,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function createHeatmapChart(data) {
            const ctx = document.getElementById('heatmapChart');
            
            if (charts.heatmap) {
                charts.heatmap.destroy();
            }
            
            const hourlyStats = {};
            for (let h = 0; h < 24; h++) {
                hourlyStats[h] = 0;
            }
            
            data.forEach(row => {
                const date = new Date(row.utterance_date);
                if (!isNaN(date)) {
                    const hour = date.getHours();
                    hourlyStats[hour]++;
                }
            });
            
            const hours = Object.keys(hourlyStats);
            const values = hours.map(h => hourlyStats[h]);
            
            charts.heatmap = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours.map(h => `${h}æ™‚`),
                    datasets: [{
                        label: 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°',
                        data: values,
                        backgroundColor: values.map(v => {
                            const intensity = Math.max(...values) > 0 ? v / Math.max(...values) : 0;
                            return `rgba(16, 185, 129, ${0.3 + intensity * 0.7})`;
                        }),
                        borderColor: '#10b981',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚°ãƒ©ãƒ•
        function createPlatformChart(data) {
            const ctx = document.getElementById('platformChart');
            
            if (charts.platform) {
                charts.platform.destroy();
            }
            
            const platformStats = {};
            data.forEach(row => {
                const platform = row.platform || 'unknown';
                platformStats[platform] = (platformStats[platform] || 0) + 1;
            });
            
            const labels = Object.keys(platformStats);
            const values = Object.values(platformStats);
            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'];
            
            charts.platform = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†å¸ƒã‚°ãƒ©ãƒ•
        function createSessionChart(data) {
            const ctx = document.getElementById('sessionChart');
            
            if (charts.session) {
                charts.session.destroy();
            }
            
            const sessions = {};
            data.forEach(row => {
                if (row.session_id) {
                    sessions[row.session_id] = (sessions[row.session_id] || 0) + 1;
                }
            });
            
            const sessionLengths = Object.values(sessions);
            const distribution = {};
            
            sessionLengths.forEach(length => {
                let category;
                if (length === 1) category = '1ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸';
                else if (length <= 3) category = '2-3ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸';
                else if (length <= 5) category = '4-5ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸';
                else if (length <= 10) category = '6-10ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸';
                else category = '11+ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸';
                
                distribution[category] = (distribution[category] || 0) + 1;
            });
            
            const labels = ['1ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', '2-3ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', '4-5ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', '6-10ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', '11+ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸'];
            const values = labels.map(label => distribution[label] || 0);
            
            charts.session = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°',
                        data: values,
                        backgroundColor: '#3b82f6',
                        borderColor: '#2563eb',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // æœŸé–“æ¯”è¼ƒ
        function comparePeriods() {
            if (!currentData) {
                showError('ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            const startDate1 = new Date(document.getElementById('startDate1').value);
            const endDate1 = new Date(document.getElementById('endDate1').value);
            const startDate2 = new Date(document.getElementById('startDate2').value);
            const endDate2 = new Date(document.getElementById('endDate2').value);
            
            if (isNaN(startDate1) || isNaN(endDate1) || isNaN(startDate2) || isNaN(endDate2)) {
                showError('ã™ã¹ã¦ã®æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (startDate1 >= endDate1 || startDate2 >= endDate2) {
                showError('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã«è¨­å®šã—ã¦ãã ã•ã„');
                return;
            }
            
            showLoading(true);
            
            // éåŒæœŸå‡¦ç†ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒç¢ºå®Ÿã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
            setTimeout(() => {
                try {
                    period1Data = filterDataByPeriod(currentData, startDate1, endDate1);
                    period2Data = filterDataByPeriod(currentData, startDate2, endDate2);
                    
                    const stats1 = calculateStats(period1Data);
                    const stats2 = calculateStats(period2Data);
                    
                    updateStatsDisplay(stats1, stats2);
                    createComparisonCharts(period1Data, period2Data);
                    
                    // ä¼šè©±å†…å®¹åˆ†æã¯æœŸé–“1ã®ãƒ‡ãƒ¼ã‚¿ã§å®Ÿè¡Œ
                    analyzeContent(period1Data);
                    
                    showLoading(false);
                    showSuccess(`æœŸé–“æ¯”è¼ƒã‚’å®Ÿè¡Œã—ã¾ã—ãŸï¼ˆæœŸé–“1: ${period1Data.length}ä»¶ã€æœŸé–“2: ${period2Data.length}ä»¶ï¼‰`);
                    
                } catch (error) {
                    console.error('æœŸé–“æ¯”è¼ƒã‚¨ãƒ©ãƒ¼:', error);
                    showLoading(false);
                    showError('æœŸé–“æ¯”è¼ƒä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            }, 100);
        }

        // æœŸé–“ã§ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿
        function filterDataByPeriod(data, startDate, endDate) {
            return data.filter(row => {
                const date = new Date(row.utterance_date);
                return !isNaN(date) && date >= startDate && date <= endDate;
            });
        }

        // æ¯”è¼ƒã‚°ãƒ©ãƒ•ä½œæˆ
        function createComparisonCharts(data1, data2) {
            createComparisonTimeSeriesChart(data1, data2);
            createComparisonPlatformChart(data1, data2);
        }

        // æ¯”è¼ƒæ™‚ç³»åˆ—ã‚°ãƒ©ãƒ•
        function createComparisonTimeSeriesChart(data1, data2) {
            const ctx = document.getElementById('timeSeriesChart');
            
            if (charts.timeSeries) {
                charts.timeSeries.destroy();
            }
            
            const getDailyStats = (data) => {
                const stats = {};
                data.forEach(row => {
                    const date = new Date(row.utterance_date);
                    if (!isNaN(date)) {
                        const dateKey = date.toISOString().split('T')[0];
                        stats[dateKey] = (stats[dateKey] || 0) + 1;
                    }
                });
                return stats;
            };
            
            const dailyStats1 = getDailyStats(data1);
            const dailyStats2 = getDailyStats(data2);
            
            const allDates = [...new Set([...Object.keys(dailyStats1), ...Object.keys(dailyStats2)])].sort();
            
            charts.timeSeries = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allDates.map(date => new Date(date).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'æœŸé–“1',
                        data: allDates.map(date => dailyStats1[date] || 0),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    }, {
                        label: 'æœŸé–“2',
                        data: allDates.map(date => dailyStats2[date] || 0),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // æ¯”è¼ƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚°ãƒ©ãƒ•
        function createComparisonPlatformChart(data1, data2) {
            const ctx = document.getElementById('platformChart');
            
            if (charts.platform) {
                charts.platform.destroy();
            }
            
            const getPlatformStats = (data) => {
                const stats = {};
                data.forEach(row => {
                    const platform = row.platform || 'unknown';
                    stats[platform] = (stats[platform] || 0) + 1;
                });
                return stats;
            };
            
            const platformStats1 = getPlatformStats(data1);
            const platformStats2 = getPlatformStats(data2);
            
            const allPlatforms = [...new Set([...Object.keys(platformStats1), ...Object.keys(platformStats2)])];
            
            charts.platform = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: allPlatforms,
                    datasets: [{
                        label: 'æœŸé–“1',
                        data: allPlatforms.map(platform => platformStats1[platform] || 0),
                        backgroundColor: '#10b981',
                        borderColor: '#059669',
                        borderWidth: 1
                    }, {
                        label: 'æœŸé–“2',
                        data: allPlatforms.map(platform => platformStats2[platform] || 0),
                        backgroundColor: '#3b82f6',
                        borderColor: '#2563eb',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportStats() {
            if (!currentData) {
                showError('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const stats = calculateStats(currentData);
            
            const csvData = [
                ['é …ç›®', 'å€¤'],
                ['ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°', stats.totalMessages],
                ['ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°', stats.uniqueUsers],
                ['å¹³å‡ã‚»ãƒƒã‚·ãƒ§ãƒ³é•·', stats.avgSessionLength],
                ['æ´»å‹•æœŸé–“', stats.activityPeriod],
                ['ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆæ—¥æ™‚', new Date().toLocaleString('ja-JP')]
            ];
            
            downloadCSV(csvData, 'miibo_stats_' + getCurrentTimestamp() + '.csv');
        }

        function exportTimeSeries() {
            if (!currentData) {
                showError('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const dailyStats = {};
            currentData.forEach(row => {
                const date = new Date(row.utterance_date);
                if (!isNaN(date)) {
                    const dateKey = date.toISOString().split('T')[0];
                    dailyStats[dateKey] = (dailyStats[dateKey] || 0) + 1;
                }
            });
            
            const csvData = [['æ—¥ä»˜', 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°']];
            Object.keys(dailyStats).sort().forEach(date => {
                csvData.push([date, dailyStats[date]]);
            });
            
            downloadCSV(csvData, 'miibo_timeseries_' + getCurrentTimestamp() + '.csv');
        }

        function exportContentAnalysis() {
            if (!currentData) {
                showError('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ç™ºè©±é »åº¦ãƒ‡ãƒ¼ã‚¿
            const utterances = currentData.map(row => row.utterance).filter(Boolean);
            const frequency = {};
            
            utterances.forEach(utterance => {
                const cleaned = utterance.trim();
                if (cleaned) {
                    frequency[cleaned] = (frequency[cleaned] || 0) + 1;
                }
            });
            
            const sortedUtterances = Object.entries(frequency)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 20);
            
            // CSVãƒ‡ãƒ¼ã‚¿ä½œæˆ
            const csvData = [
                ['ç™ºè©±å†…å®¹åˆ†æ'],
                ['é †ä½', 'ç™ºè©±å†…å®¹', 'å‡ºç¾å›æ•°'],
                ...sortedUtterances.map(([utterance, count], index) => [index + 1, utterance, count]),
                [''],
                ['åŸºæœ¬çµ±è¨ˆ'],
                ['é …ç›®', 'å€¤'],
                ['ç·ç™ºè©±æ•°', utterances.length],
                ['ãƒ¦ãƒ‹ãƒ¼ã‚¯ç™ºè©±æ•°', Object.keys(frequency).length],
                ['å¹³å‡æ–‡å­—æ•°', utterances.length > 0 ? (utterances.reduce((sum, u) => sum + u.length, 0) / utterances.length).toFixed(1) : 0],
                [''],
                ['ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆæ—¥æ™‚', new Date().toLocaleString('ja-JP')]
            ];
            
            downloadCSV(csvData, 'miibo_content_analysis_' + getCurrentTimestamp() + '.csv');
        }

        function downloadCSV(data, filename) {
            const csv = data.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSuccess(`${filename} ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`);
            }
        }

        // åˆæœŸè¡¨ç¤ºã«ãƒªã‚»ãƒƒãƒˆ
        function resetToInitialView() {
            if (!currentData) {
                showError('ãƒªã‚»ãƒƒãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            showLoading(true);
            
            try {
                // æœŸé–“æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                period1Data = null;
                period2Data = null;
                
                // æœŸé–“é¸æŠã®æ—¥ä»˜ã‚’åˆæœŸå€¤ã«æˆ»ã™
                resetPeriodDates();
                
                // çµ±è¨ˆè¡¨ç¤ºã‚’å…ƒã«æˆ»ã™
                const stats = calculateStats(currentData);
                updateStatsDisplay(stats); // æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ãªã—ã§æ›´æ–°
                
                // ã‚°ãƒ©ãƒ•ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
                createCharts(currentData);
                
                // ä¼šè©±å†…å®¹åˆ†æã‚‚åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
                analyzeContent(currentData);
                
                showLoading(false);
                showSuccess('åˆæœŸè¡¨ç¤ºã«æˆ»ã—ã¾ã—ãŸï¼ˆæœŸé–“è¨­å®šã‚‚ãƒªã‚»ãƒƒãƒˆï¼‰');
                
            } catch (error) {
                console.error('ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showLoading(false);
                showError('ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // æœŸé–“æ—¥ä»˜ã‚’ãƒªã‚»ãƒƒãƒˆ
        function resetPeriodDates() {
            if (window.initialPeriodDates) {
                document.getElementById('startDate1').value = window.initialPeriodDates.startDate1;
                document.getElementById('endDate1').value = window.initialPeriodDates.endDate1;
                document.getElementById('startDate2').value = window.initialPeriodDates.startDate2;
                document.getElementById('endDate2').value = window.initialPeriodDates.endDate2;
            }
        }

        function getCurrentTimestamp() {
            return new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
        }

        // UIåˆ¶å¾¡é–¢æ•°
        function showLoading(show) {
            const loadingEl = document.getElementById('loading');
            if (loadingEl) {
                if (show) {
                    loadingEl.classList.add('show');
                } else {
                    loadingEl.classList.remove('show');
                }
            }
        }

        function showError(message) {
            // ã¾ãšãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç¢ºå®Ÿã«éè¡¨ç¤º
            showLoading(false);
            hideProgress();
            
            const errorEl = document.getElementById('errorMessage');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => {
                    errorEl.style.display = 'none';
                }, 5000);
            }
        }

        function showSuccess(message) {
            // ã¾ãšãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç¢ºå®Ÿã«éè¡¨ç¤º
            showLoading(false);
            hideProgress();
            
            const successEl = document.getElementById('successMessage');
            if (successEl) {
                successEl.textContent = message;
                successEl.style.display = 'block';
                setTimeout(() => {
                    successEl.style.display = 'none';
                }, 3000);
            }
        }

        function updateFileInfo(filename, recordCount) {
            document.getElementById('fileInfo').textContent = 
                `ãƒ•ã‚¡ã‚¤ãƒ«: ${filename} (${recordCount.toLocaleString()}ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰)`;
        }

        function showSections() {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç¢ºå®Ÿã«éè¡¨ç¤º
            showLoading(false);
            hideProgress();
            
            document.getElementById('noData').style.display = 'none';
            document.getElementById('statsGrid').style.display = 'grid';
            document.getElementById('chartsGrid').style.display = 'grid';
            document.getElementById('contentAnalysisSection').style.display = 'block';
            document.getElementById('exportSection').style.display = 'block';
        }

        // ä¼šè©±å†…å®¹åˆ†æ
        function analyzeContent(data) {
            analyzeUtteranceFrequency(data);
            analyzeKeywords(data);
            analyzeBehaviorPatterns(data);
            analyzeTextStats(data);
            analyzeEmotions(data);
        }

        // ç™ºè©±é »åº¦åˆ†æ
        function analyzeUtteranceFrequency(data) {
            const utterances = data.map(row => row.utterance).filter(Boolean);
            const frequency = {};
            
            utterances.forEach(utterance => {
                const cleaned = utterance.trim();
                if (cleaned) {
                    frequency[cleaned] = (frequency[cleaned] || 0) + 1;
                }
            });
            
            const sorted = Object.entries(frequency)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            const rankingList = document.getElementById('utteranceRanking');
            rankingList.innerHTML = '';
            
            sorted.forEach(([utterance, count], index) => {
                const item = document.createElement('div');
                item.className = 'ranking-item';
                
                item.innerHTML = `
                    <div class="ranking-number ${index < 3 ? 'top3' : ''}">${index + 1}</div>
                    <div class="ranking-text">"${utterance}"</div>
                    <div class="ranking-count">${count}å›</div>
                `;
                
                rankingList.appendChild(item);
            });
        }

        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æ
        function analyzeKeywords(data) {
            const utterances = data.map(row => row.utterance).filter(Boolean);
            const keywords = {};
            
            // æ—¥æœ¬èªã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
            const keywordPatterns = [
                'ã‚ã‚ŠãŒã¨ã†', 'ã“ã‚“ã«ã¡ã¯', 'ã™ã¿ã¾ã›ã‚“', 'ãŠé¡˜ã„', 'æ•™ãˆã¦',
                'ã‚ã‹ã‚‰ãªã„', 'å›°ã£ã¦ã„ã‚‹', 'ä¸å®‰', 'æ‚©ã¿', 'ç›¸è«‡',
                'è³ªå•', 'å•é¡Œ', 'ãƒˆãƒ©ãƒ–ãƒ«', 'ã‚¨ãƒ©ãƒ¼', 'ã§ããªã„',
                'æ–¹æ³•', 'ã‚„ã‚Šæ–¹', 'æ‰‹é †', 'è¨­å®š', 'ä½¿ã„æ–¹'
            ];
            
            utterances.forEach(utterance => {
                keywordPatterns.forEach(keyword => {
                    if (utterance.includes(keyword)) {
                        keywords[keyword] = (keywords[keyword] || 0) + 1;
                    }
                });
            });
            
            const sortedKeywords = Object.entries(keywords)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8);
            
            if (sortedKeywords.length > 0) {
                createKeywordChart(sortedKeywords);
            }
        }

        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
        function createKeywordChart(keywordData) {
            const ctx = document.getElementById('keywordChart');
            
            if (charts.keyword) {
                charts.keyword.destroy();
            }
            
            const labels = keywordData.map(([keyword]) => keyword);
            const values = keywordData.map(([, count]) => count);
            
            charts.keyword = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å‡ºç¾å›æ•°',
                        data: values,
                        backgroundColor: '#10b981',
                        borderColor: '#059669',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ
        function analyzeBehaviorPatterns(data) {
            const total = data.length;
            const patterns = {
                'æŒ¨æ‹¶': 0,
                'è³ªå•': 0,
                'æ„Ÿè¬': 0,
                'ç›¸è«‡': 0,
                'ãã®ä»–': 0
            };
            
            data.forEach(row => {
                const utterance = row.utterance || '';
                
                if (utterance.match(/(ã“ã‚“ã«ã¡ã¯|ã“ã‚“ã°ã‚“ã¯|ãŠã¯ã‚ˆã†|åˆã‚ã¾ã—ã¦)/)) {
                    patterns['æŒ¨æ‹¶']++;
                } else if (utterance.match(/(ï¼Ÿ|\?|ãªã«|ã©ã†|ã„ã¤|ã©ã“|èª°|ä½•)/)) {
                    patterns['è³ªå•']++;
                } else if (utterance.match(/(ã‚ã‚ŠãŒã¨ã†|æ„Ÿè¬|åŠ©ã‹ã‚Š)/)) {
                    patterns['æ„Ÿè¬']++;
                } else if (utterance.match(/(å›°ã£|æ‚©ã¿|ä¸å®‰|ç›¸è«‡|å•é¡Œ)/)) {
                    patterns['ç›¸è«‡']++;
                } else {
                    patterns['ãã®ä»–']++;
                }
            });
            
            createBehaviorChart(patterns);
        }

        // è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
        function createBehaviorChart(patterns) {
            const ctx = document.getElementById('behaviorChart');
            
            if (charts.behavior) {
                charts.behavior.destroy();
            }
            
            const labels = Object.keys(patterns);
            const values = Object.values(patterns);
            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'];
            
            charts.behavior = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // ãƒ†ã‚­ã‚¹ãƒˆçµ±è¨ˆåˆ†æ
        function analyzeTextStats(data) {
            const utterances = data.map(row => row.utterance).filter(Boolean);
            const lengths = utterances.map(u => u.length);
            
            const stats = {
                total: utterances.length,
                avgLength: lengths.length > 0 ? (lengths.reduce((a, b) => a + b, 0) / lengths.length).toFixed(1) : 0,
                minLength: lengths.length > 0 ? Math.min(...lengths) : 0,
                maxLength: lengths.length > 0 ? Math.max(...lengths) : 0
            };
            
            const textStatsContainer = document.getElementById('textStats');
            textStatsContainer.innerHTML = `
                <div class="text-stat-item">
                    <div class="text-stat-value">${stats.total}</div>
                    <div class="text-stat-label">ç·ç™ºè©±æ•°</div>
                </div>
                <div class="text-stat-item">
                    <div class="text-stat-value">${stats.avgLength}</div>
                    <div class="text-stat-label">å¹³å‡æ–‡å­—æ•°</div>
                </div>
                <div class="text-stat-item">
                    <div class="text-stat-value">${stats.minLength}</div>
                    <div class="text-stat-label">æœ€çŸ­æ–‡å­—æ•°</div>
                </div>
                <div class="text-stat-item">
                    <div class="text-stat-value">${stats.maxLength}</div>
                    <div class="text-stat-label">æœ€é•·æ–‡å­—æ•°</div>
                </div>
            `;
        }

        // æ„Ÿæƒ…ãƒ»æ„å›³åˆ†æ
        function analyzeEmotions(data) {
            const total = data.length;
            const emotions = {
                positive: { count: 0, icon: 'ğŸ˜Š', label: 'ãƒã‚¸ãƒ†ã‚£ãƒ–', keywords: ['ã‚ã‚ŠãŒã¨ã†', 'å¬‰ã—ã„', 'åŠ©ã‹ã‚Š', 'è‰¯ã„', 'ç´ æ™´ã‚‰ã—ã„'] },
                question: { count: 0, icon: 'â“', label: 'è³ªå•ãƒ»ç–‘å•', keywords: ['ï¼Ÿ', '?', 'ã©ã†', 'ãªã«', 'æ•™ãˆã¦'] },
                concern: { count: 0, icon: 'ğŸ˜Ÿ', label: 'ä¸å®‰ãƒ»ç›¸è«‡', keywords: ['ä¸å®‰', 'å›°', 'æ‚©ã¿', 'å¿ƒé…', 'å•é¡Œ'] },
                greeting: { count: 0, icon: 'ğŸ‘‹', label: 'æŒ¨æ‹¶', keywords: ['ã“ã‚“ã«ã¡ã¯', 'ã“ã‚“ã°ã‚“ã¯', 'ãŠã¯ã‚ˆã†', 'åˆã‚ã¾ã—ã¦'] },
                neutral: { count: 0, icon: 'ğŸ˜', label: 'ä¸­ç«‹ãƒ»ãã®ä»–', keywords: [] }
            };
            
            data.forEach(row => {
                const utterance = row.utterance || '';
                let categorized = false;
                
                for (const [key, emotion] of Object.entries(emotions)) {
                    if (key === 'neutral') continue;
                    
                    if (emotion.keywords.some(keyword => utterance.includes(keyword))) {
                        emotion.count++;
                        categorized = true;
                        break;
                    }
                }
                
                if (!categorized) {
                    emotions.neutral.count++;
                }
            });
            
            const emotionContainer = document.getElementById('emotionAnalysis');
            emotionContainer.innerHTML = '';
            
            Object.entries(emotions).forEach(([key, emotion]) => {
                const percentage = total > 0 ? ((emotion.count / total) * 100).toFixed(1) : 0;
                
                const item = document.createElement('div');
                item.className = 'emotion-item';
                
                item.innerHTML = `
                    <span class="emotion-icon">${emotion.icon}</span>
                    <div class="emotion-label">${emotion.label}</div>
                    <div class="emotion-count">${emotion.count}</div>
                    <div class="emotion-percentage">${percentage}%</div>
                `;
                
                emotionContainer.appendChild(item);
            });
        }
    </script>
</body>
</html>