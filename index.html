<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">

    <title>miiboログ分析ダッシュボード</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
:root {
  --primary-color: #10b981;
  --primary-hover: #059669;
  --secondary-color: #6b7280;
  --accent-color: #3b82f6;
  --success-color: #22c55e;
  --warning-color: #f59e0b;
  --error-color: #ef4444;
  --bg-color: #f9fafb;
  --card-bg: #ffffff;
  --border-color: #e5e7eb;
  --text-color: #111827;
  --text-secondary: #6b7280;
  --border-radius: 12px;
  --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
  --transition: all 0.3s ease;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Noto Sans JP', sans-serif;
  background-color: var(--bg-color);
  color: var(--text-color);
  line-height: 1.6;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

/* ヘッダー */
.header {
  background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
  color: white;
  padding: 30px;
  border-radius: var(--border-radius);
  margin-bottom: 30px;
  text-align: center;
  box-shadow: var(--box-shadow);
}

.header h1 {
  font-size: 2.5rem;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
}

.header p {
  font-size: 1.1rem;
  opacity: 0.9;
}

.miibo-icon {
  background: rgba(255, 255, 255, 0.2);
  padding: 12px;
  border-radius: 50%;
  font-size: 1.8rem;
}

/* アップロードエリア */
.upload-section {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 30px;
  margin-bottom: 30px;
  box-shadow: var(--box-shadow);
  border: 2px dashed var(--border-color);
  transition: var(--transition);
}

.upload-section.dragover {
  border-color: var(--primary-color);
  background: rgba(16, 185, 129, 0.05);
}

.upload-area {
  text-align: center;
  padding: 20px;
}

.upload-area input[type="file"] {
  display: none;
}

.upload-btn {
  background: var(--primary-color);
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: 8px;
  font-size: 1.1rem;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 10px;
}

.upload-btn:hover {
  background: var(--primary-hover);
  transform: translateY(-2px);
}

.file-info {
  margin-top: 15px;
  font-size: 0.9rem;
  color: var(--text-secondary);
}

/* 期間選択 */
.period-controls {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.period-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.period-group label {
  font-weight: 500;
  color: var(--text-color);
}

.period-group input {
  padding: 10px;
  border: 2px solid var(--border-color);
  border-radius: 6px;
  font-size: 1rem;
  transition: var(--transition);
}

.period-group input:focus {
  border-color: var(--primary-color);
  outline: none;
}

.compare-btn {
  background: var(--accent-color);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
}

.compare-btn:hover {
  background: #2563eb;
}

.compare-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* 統計カード */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 25px;
  box-shadow: var(--box-shadow);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.stat-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--primary-color);
}

.stat-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 15px;
}

.stat-title {
  font-size: 0.9rem;
  color: var(--text-secondary);
  font-weight: 500;
}

.stat-icon {
  color: var(--primary-color);
  font-size: 1.2rem;
}

.stat-value {
  font-size: 2.2rem;
  font-weight: 700;
  color: var(--text-color);
  margin-bottom: 5px;
}

.stat-change {
  font-size: 0.85rem;
  font-weight: 500;
}

.stat-change.positive {
  color: var(--success-color);
}

.stat-change.negative {
  color: var(--error-color);
}

.stat-change.neutral {
  color: var(--text-secondary);
}

/* グラフエリア */
.charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 30px;
  margin-bottom: 30px;
}

.chart-card {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 25px;
  box-shadow: var(--box-shadow);
}

.chart-title {
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--text-color);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.chart-container {
  position: relative;
  height: 300px;
}

.chart-container canvas {
  max-height: 100%;
}

/* エクスポートセクション */
.export-section {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 25px;
  box-shadow: var(--box-shadow);
  text-align: center;
}

.export-buttons {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 15px;
}

.export-btn {
  background: var(--secondary-color);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 8px;
}

.export-btn:hover {
  background: #4b5563;
  transform: translateY(-1px);
}

.export-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ローディング */
.loading {
  display: none;
  text-align: center;
  padding: 40px;
  color: var(--text-secondary);
}

.loading.show {
  display: block;
}

.spinner {
  display: inline-block;
  width: 40px;
  height: 40px;
  border: 3px solid var(--border-color);
  border-radius: 50%;
  border-top-color: var(--primary-color);
  animation: spin 1s ease-in-out infinite;
  margin-bottom: 15px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* エラー表示 */
.error-message {
  background: #fef2f2;
  border: 1px solid #fecaca;
  color: #b91c1c;
  padding: 15px;
  border-radius: 8px;
  margin: 15px 0;
  display: none;
}

.success-message {
  background: #f0fdf4;
  border: 1px solid #bbf7d0;
  color: #166534;
  padding: 15px;
  border-radius: 8px;
  margin: 15px 0;
  display: none;
}

/* レスポンシブ */
@media (max-width: 768px) {
  .container {
    padding: 15px;
  }
  
  .header h1 {
    font-size: 2rem;
    flex-direction: column;
  }
  
  .charts-grid {
    grid-template-columns: 1fr;
  }
  
  .chart-container {
    height: 250px;
  }
  
  .export-buttons {
    flex-direction: column;
    align-items: center;
  }
  
  .period-controls {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .stat-value {
    font-size: 1.8rem;
  }
}

/* 会話内容分析セクション */
.content-analysis-section {
  margin: 30px 0;
}

.section-header {
  text-align: center;
  margin-bottom: 30px;
  padding: 20px;
  background: var(--card-bg);
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
}

.section-header h2 {
  font-size: 2rem;
  color: var(--primary-color);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
}

.section-header p {
  color: var(--text-secondary);
  font-size: 1.1rem;
}

.content-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 25px;
}

.content-card {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 25px;
  box-shadow: var(--box-shadow);
  transition: var(--transition);
}

.content-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.content-card.full-width {
  grid-column: 1 / -1;
}

.content-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--text-color);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 2px solid var(--border-color);
  padding-bottom: 10px;
}

.content-title i {
  color: var(--primary-color);
}

/* ランキングリスト */
.ranking-list {
  max-height: 300px;
  overflow-y: auto;
}

.ranking-item {
  display: flex;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--border-color);
  transition: var(--transition);
}

.ranking-item:last-child {
  border-bottom: none;
}

.ranking-item:hover {
  background: var(--bg-color);
  margin: 0 -15px;
  padding-left: 15px;
  padding-right: 15px;
  border-radius: 6px;
}

.ranking-number {
  background: var(--primary-color);
  color: white;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 0.9rem;
  margin-right: 15px;
  flex-shrink: 0;
}

.ranking-number.top3 {
  background: linear-gradient(45deg, #ffd700, #ffed4e);
  color: #92400e;
}

.ranking-text {
  flex: 1;
  font-size: 0.95rem;
  color: var(--text-color);
  margin-right: 10px;
  word-break: break-all;
}

.ranking-count {
  background: var(--bg-color);
  color: var(--text-secondary);
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 500;
}

/* テキスト統計 */
.text-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 15px;
}

.text-stat-item {
  text-align: center;
  padding: 15px;
  background: var(--bg-color);
  border-radius: 8px;
  border: 1px solid var(--border-color);
}

.text-stat-value {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--primary-color);
  margin-bottom: 5px;
}

.text-stat-label {
  font-size: 0.85rem;
  color: var(--text-secondary);
  font-weight: 500;
}

/* 感情分析グリッド */
.emotion-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}

.emotion-item {
  text-align: center;
  padding: 20px;
  background: var(--bg-color);
  border-radius: 8px;
  border: 1px solid var(--border-color);
  transition: var(--transition);
}

.emotion-item:hover {
  border-color: var(--primary-color);
  transform: translateY(-2px);
}

.emotion-icon {
  font-size: 2.5rem;
  margin-bottom: 10px;
  display: block;
}

.emotion-label {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-color);
  margin-bottom: 8px;
}

.emotion-count {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--primary-color);
  margin-bottom: 5px;
}

.emotion-percentage {
  font-size: 0.85rem;
  color: var(--text-secondary);
}
    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <header class="header">
            <h1>
                <div class="miibo-icon">
                    <i class="fas fa-robot"></i>
                </div>
                miiboログ分析ダッシュボード
            </h1>
            <p>CSVファイルをアップロードして、ユーザー行動とエンゲージメントを分析しましょう</p>
        </header>

        <!-- ファイルアップロード -->
        <section class="upload-section" id="uploadSection">
            <div class="upload-area">
                <input type="file" id="csvFile" accept=".csv" />
                <button class="upload-btn" onclick="document.getElementById('csvFile').click()">
                    <i class="fas fa-upload"></i>
                    CSVファイルを選択
                </button>
                <div class="file-info" id="fileInfo">
                    CSVファイルをドラッグ&ドロップするか、上のボタンをクリックしてください
                </div>
            </div>
            
            <!-- 期間選択 -->
            <div class="period-controls" id="periodControls" style="display: none;">
                <div class="period-group">
                    <label for="startDate1">期間1 開始日</label>
                    <input type="date" id="startDate1" />
                </div>
                <div class="period-group">
                    <label for="endDate1">期間1 終了日</label>
                    <input type="date" id="endDate1" />
                </div>
                <div class="period-group">
                    <label for="startDate2">期間2 開始日</label>
                    <input type="date" id="startDate2" />
                </div>
                <div class="period-group">
                    <label for="endDate2">期間2 終了日</label>
                    <input type="date" id="endDate2" />
                </div>
                <div class="period-group">
                    <button class="compare-btn" id="compareBtn" onclick="comparePeriods()">
                        <i class="fas fa-chart-line"></i>
                        期間比較実行
                    </button>
                </div>
                <div class="period-group">
                    <button class="reset-btn" id="resetBtn" onclick="resetToInitialView()">
                        <i class="fas fa-undo"></i>
                        初期表示にリセット
                    </button>
                </div>
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            <div class="data-warning" id="dataWarning">
                <div id="warningContent"></div>
                <div class="warning-actions" id="warningActions"></div>
            </div>
            <div class="progress-bar-container" id="progressContainer">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText"></div>
            </div>
            <div class="performance-info" id="performanceInfo"></div>
        </section>

        <!-- ローディング -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
        </div>

        <!-- 統計カード -->
        <section class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">総メッセージ数</span>
                    <i class="fas fa-comments stat-icon"></i>
                </div>
                <div class="stat-value" id="totalMessages">0</div>
                <div class="stat-change" id="totalMessagesChange"></div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">ユニークユーザー数</span>
                    <i class="fas fa-users stat-icon"></i>
                </div>
                <div class="stat-value" id="uniqueUsers">0</div>
                <div class="stat-change" id="uniqueUsersChange"></div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">平均セッション長</span>
                    <i class="fas fa-clock stat-icon"></i>
                </div>
                <div class="stat-value" id="avgSessionLength">0</div>
                <div class="stat-change" id="avgSessionLengthChange"></div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">活動期間</span>
                    <i class="fas fa-calendar stat-icon"></i>
                </div>
                <div class="stat-value" id="activityPeriod">-</div>
                <div class="stat-change" id="activityPeriodChange"></div>
            </div>
        </section>

        <!-- グラフエリア -->
        <section class="charts-grid" id="chartsGrid" style="display: none;">
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    時系列トレンド
                </h3>
                <div class="chart-container">
                    <canvas id="timeSeriesChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-th"></i>
                    時間帯ヒートマップ
                </h3>
                <div class="chart-container">
                    <canvas id="heatmapChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    プラットフォーム比較
                </h3>
                <div class="chart-container">
                    <canvas id="platformChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-chart-bar"></i>
                    セッション分布
                </h3>
                <div class="chart-container">
                    <canvas id="sessionChart"></canvas>
                </div>
            </div>
        </section>

        <!-- 会話内容分析セクション -->
        <section class="content-analysis-section" id="contentAnalysisSection" style="display: none;">
            <div class="section-header">
                <h2>
                    <i class="fas fa-comments"></i>
                    会話内容分析
                </h2>
                <p>発話内容とユーザーの関心事を分析します</p>
            </div>
            
            <div class="content-grid">
                <!-- 発話頻度ランキング -->
                <div class="content-card">
                    <h3 class="content-title">
                        <i class="fas fa-trophy"></i>
                        よくある発話 TOP10
                    </h3>
                    <div class="ranking-list" id="utteranceRanking">
                        <!-- JavaScriptで動的生成 -->
                    </div>
                </div>

                <!-- キーワード分析 -->
                <div class="content-card">
                    <h3 class="content-title">
                        <i class="fas fa-tags"></i>
                        キーワード頻度分析
                    </h3>
                    <div class="chart-container">
                        <canvas id="keywordChart"></canvas>
                    </div>
                </div>

                <!-- ユーザー行動パターン -->
                <div class="content-card">
                    <h3 class="content-title">
                        <i class="fas fa-user-friends"></i>
                        ユーザー行動パターン
                    </h3>
                    <div class="chart-container">
                        <canvas id="behaviorChart"></canvas>
                    </div>
                </div>

                <!-- 文字数分析 -->
                <div class="content-card">
                    <h3 class="content-title">
                        <i class="fas fa-text-width"></i>
                        発話文字数分析
                    </h3>
                    <div class="text-stats" id="textStats">
                        <!-- JavaScriptで動的生成 -->
                    </div>
                </div>

                <!-- 感情・意図分析 -->
                <div class="content-card full-width">
                    <h3 class="content-title">
                        <i class="fas fa-heart"></i>
                        感情・意図分析
                    </h3>
                    <div class="emotion-grid" id="emotionAnalysis">
                        <!-- JavaScriptで動的生成 -->
                    </div>
                </div>
            </div>
        </section>

        <!-- エクスポートセクション -->
        <section class="export-section" id="exportSection" style="display: none;">
            <h3>
                <i class="fas fa-download"></i>
                分析結果をエクスポート
            </h3>
            <p>分析したデータをCSV形式でダウンロードできます</p>
            <div class="export-buttons">
                <button class="export-btn" id="exportStatsBtn" onclick="exportStats()">
                    <i class="fas fa-table"></i>
                    統計データをCSV出力
                </button>
                <button class="export-btn" id="exportTimeSeriesBtn" onclick="exportTimeSeries()">
                    <i class="fas fa-chart-line"></i>
                    時系列データをCSV出力
                </button>
                <button class="export-btn" id="exportContentBtn" onclick="exportContentAnalysis()">
                    <i class="fas fa-comments"></i>
                    会話内容分析をCSV出力
                </button>
            </div>
        </section>

        <!-- データなし状態 -->
        <div class="no-data" id="noData">
            <i class="fas fa-chart-bar"></i>
            <h3>データを読み込んでください</h3>
            <p>CSVファイルをアップロードすると、分析結果がここに表示されます</p>
        </div>
    </div>

    <script>
        // グローバル変数
        let currentData = null;
        let period1Data = null;
        let period2Data = null;
        let charts = {
            timeSeries: null,
            heatmap: null,
            platform: null,
            session: null,
            keyword: null,
            behavior: null
        };

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload();
            setupDragAndDrop();
        });

        // ファイルアップロード設定
        function setupFileUpload() {
            const fileInput = document.getElementById('csvFile');
            fileInput.addEventListener('change', handleFileSelect);
        }

        // ドラッグ&ドロップ設定
        function setupDragAndDrop() {
            const uploadSection = document.getElementById('uploadSection');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadSection.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadSection.addEventListener(eventName, () => {
                    uploadSection.classList.add('dragover');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadSection.addEventListener(eventName, () => {
                    uploadSection.classList.remove('dragover');
                }, false);
            });

            uploadSection.addEventListener('drop', handleDrop, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // ファイル処理（修正版）
        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showError('CSVファイルを選択してください');
                return;
            }

            // ファイルサイズの簡易チェック
            const sizeMB = file.size / (1024 * 1024);
            if (sizeMB > 50) {
                showError(`ファイルサイズが大きすぎます（${sizeMB.toFixed(1)}MB）。50MB以下のファイルを使用してください。`);
                return;
            }

            showLoading(true);
            if (sizeMB > 10) {
                showProgress(0, '大きなファイルを処理中...');
            }
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        showError('CSVファイルの解析に失敗しました');
                        hideProgress();
                        showLoading(false);
                        return;
                    }
                    
                    const recordCount = results.data.length;
                    
                    // データ量チェックと警告表示
                    if (recordCount > 50000) {
                        hideProgress();
                        showLoading(false);
                        showCriticalWarning(recordCount, results.data, file.name);
                        return;
                    } else if (recordCount > 15000) {
                        showDataSizeWarning('heavy', recordCount);
                    } else if (recordCount > 5000) {
                        showDataSizeWarning('medium', recordCount);
                    }
                    
                    // 処理実行
                    executeDataProcessing(results.data, file.name, recordCount);
                },
                error: function() {
                    showError('ファイルの読み込みに失敗しました');
                    hideProgress();
                    showLoading(false);
                }
            });
        }

        // データ処理実行
        function executeDataProcessing(data, filename, recordCount) {
            try {
                if (recordCount > 10000) {
                    showProgress(50, 'データを分析中...');
                }
                
                currentData = data;
                updateFileInfo(filename, currentData.length);
                
                if (recordCount > 10000) {
                    showProgress(70, '期間設定を準備中...');
                }
                
                setupPeriodControls();
                
                if (recordCount > 10000) {
                    showProgress(90, 'グラフを作成中...');
                }
                
                analyzeData();
                
                // 必ず完了処理を実行
                hideProgress();
                showLoading(false);
                showSuccess(`${currentData.length.toLocaleString()}件のデータを読み込みました`);
                
                // パフォーマンス情報（必要に応じて）
                if (recordCount > 5000) {
                    setTimeout(() => {
                        showPerformanceInfo(recordCount);
                    }, 1000);
                }
                
            } catch (error) {
                console.error('データ処理エラー:', error);
                hideProgress();
                showLoading(false);
                showError('データの処理中にエラーが発生しました');
            }
        }

        // データサイズ警告表示（簡易版）
        function showDataSizeWarning(level, recordCount) {
            let message = '';
            
            if (level === 'heavy') {
                message = `⚠️ 大容量データ: ${recordCount.toLocaleString()}件 - 処理に時間がかかる場合があります`;
            } else if (level === 'medium') {
                message = `ℹ️ やや大きなデータ: ${recordCount.toLocaleString()}件 - 通常より時間がかかります`;
            }
            
            if (message) {
                const performanceEl = document.getElementById('performanceInfo');
                performanceEl.textContent = message;
                performanceEl.classList.add('show');
                
                setTimeout(() => {
                    performanceEl.classList.remove('show');
                }, 4000);
            }
        }

        // 危険レベルの警告（50,000件以上）
        function showCriticalWarning(recordCount, data, filename) {
            const warningEl = document.getElementById('dataWarning');
            const contentEl = document.getElementById('warningContent');
            const actionsEl = document.getElementById('warningActions');
            
            warningEl.className = 'data-warning critical show';
            
            contentEl.innerHTML = `
                <strong>🚨 データ量が非常に多いです</strong><br>
                ${recordCount.toLocaleString()}件のデータが検出されました。<br>
                ブラウザの動作が重くなる可能性があります。<br><br>
                <strong>推奨事項:</strong><br>
                • 期間を分割して小さなファイルにしてください<br>
                • 推奨データ量: 5,000件以下/月
            `;
            
            actionsEl.innerHTML = `
                <button class="warning-btn" onclick="forceProcessData('${filename}', ${recordCount})">
                    🚀 このまま続行（危険）
                </button>
                <button class="warning-btn" onclick="cancelProcessing()">
                    ❌ キャンセル
                </button>
            `;
        }

        // 強制処理
        function forceProcessData(filename, recordCount) {
            hideDataWarning();
            showLoading(true);
            showProgress(0, '大容量データを強制処理中...');
            
            // 少し遅延させてユーザーに状況を理解してもらう
            setTimeout(() => {
                executeDataProcessing(currentData, filename, recordCount);
            }, 500);
        }

        // 処理キャンセル
        function cancelProcessing() {
            hideDataWarning();
            document.getElementById('csvFile').value = '';
            currentData = null;
        }

        // パフォーマンス情報表示（簡略版）
        function showPerformanceInfo(recordCount) {
            const performanceEl = document.getElementById('performanceInfo');
            
            if (recordCount > 15000) {
                performanceEl.textContent = `💡 ${recordCount.toLocaleString()}件の大容量データです。グラフ表示に時間がかかる場合があります。`;
            } else if (recordCount > 5000) {
                performanceEl.textContent = `💡 ${recordCount.toLocaleString()}件のデータを処理しました。`;
            }
            
            performanceEl.classList.add('show');
            
            setTimeout(() => {
                performanceEl.classList.remove('show');
            }, 3000);
        }

        // 進捗表示（簡略版）
        function showProgress(percentage, message) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (progressContainer && progressFill && progressText) {
                progressContainer.classList.add('show');
                progressFill.style.width = `${Math.min(percentage, 100)}%`;
                progressText.textContent = message;
            }
        }

        // 進捗非表示
        function hideProgress() {
            const progressContainer = document.getElementById('progressContainer');
            if (progressContainer) {
                progressContainer.classList.remove('show');
            }
        }

        // データ警告非表示
        function hideDataWarning() {
            const warningEl = document.getElementById('dataWarning');
            if (warningEl) {
                warningEl.className = 'data-warning';
            }
        }

        // 期間選択コントロール設定
        function setupPeriodControls() {
            if (!currentData || currentData.length === 0) return;

            const dates = currentData
                .map(row => new Date(row.utterance_date))
                .filter(date => !isNaN(date));
            
            if (dates.length === 0) return;

            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            
            const startDate1 = document.getElementById('startDate1');
            const endDate1 = document.getElementById('endDate1');
            const startDate2 = document.getElementById('startDate2');
            const endDate2 = document.getElementById('endDate2');
            
            const formatDate = (date) => date.toISOString().split('T')[0];
            
            // 初期値を設定（データ範囲の前半と後半に分割）
            const initialStartDate1 = formatDate(minDate);
            const initialEndDate1 = formatDate(new Date(minDate.getTime() + (maxDate - minDate) / 2));
            const initialStartDate2 = formatDate(new Date(minDate.getTime() + (maxDate - minDate) / 2));
            const initialEndDate2 = formatDate(maxDate);
            
            startDate1.value = initialStartDate1;
            endDate1.value = initialEndDate1;
            startDate2.value = initialStartDate2;
            endDate2.value = initialEndDate2;
            
            // 初期値をグローバルに保存（リセット用）
            window.initialPeriodDates = {
                startDate1: initialStartDate1,
                endDate1: initialEndDate1,
                startDate2: initialStartDate2,
                endDate2: initialEndDate2
            };
            
            document.getElementById('periodControls').style.display = 'grid';
        }

        // データ分析
        function analyzeData(data = currentData) {
            if (!data) return;

            try {
                const stats = calculateStats(data);
                updateStatsDisplay(stats);
                createCharts(data);
                analyzeContent(data);
                showSections();
            } catch (error) {
                console.error('分析エラー:', error);
                showError('データ分析中にエラーが発生しました');
            }
        }

        // 統計計算
        function calculateStats(data) {
            const totalMessages = data.length;
            
            const uniqueUsers = new Set(
                data.map(row => row.user_uid).filter(Boolean)
            ).size;
            
            const sessions = {};
            data.forEach(row => {
                if (row.session_id) {
                    sessions[row.session_id] = (sessions[row.session_id] || 0) + 1;
                }
            });
            
            const sessionLengths = Object.values(sessions);
            const avgSessionLength = sessionLengths.length > 0 
                ? (sessionLengths.reduce((a, b) => a + b, 0) / sessionLengths.length).toFixed(1)
                : 0;
            
            const dates = data
                .map(row => new Date(row.utterance_date))
                .filter(date => !isNaN(date));
            
            let activityPeriod = '-';
            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                const days = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1;
                activityPeriod = `${days}日`;
            }
            
            return {
                totalMessages,
                uniqueUsers,
                avgSessionLength,
                activityPeriod,
                sessions,
                dates
            };
        }

        // 統計表示更新
        function updateStatsDisplay(stats, compareStats = null) {
            document.getElementById('totalMessages').textContent = stats.totalMessages.toLocaleString();
            document.getElementById('uniqueUsers').textContent = stats.uniqueUsers.toLocaleString();
            document.getElementById('avgSessionLength').textContent = stats.avgSessionLength;
            document.getElementById('activityPeriod').textContent = stats.activityPeriod;
            
            if (compareStats) {
                updateChangeIndicators(stats, compareStats);
            } else {
                clearChangeIndicators();
            }
        }

        // 変化指標更新
        function updateChangeIndicators(current, previous) {
            updateChange('totalMessagesChange', current.totalMessages, previous.totalMessages);
            updateChange('uniqueUsersChange', current.uniqueUsers, previous.uniqueUsers);
            updateChange('avgSessionLengthChange', parseFloat(current.avgSessionLength), parseFloat(previous.avgSessionLength));
        }

        function updateChange(elementId, current, previous) {
            const element = document.getElementById(elementId);
            if (previous === 0) {
                element.textContent = '';
                element.className = 'stat-change neutral';
                return;
            }
            
            const change = ((current - previous) / previous * 100).toFixed(1);
            const isPositive = current > previous;
            
            element.textContent = `${isPositive ? '+' : ''}${change}%`;
            element.className = `stat-change ${isPositive ? 'positive' : (current < previous ? 'negative' : 'neutral')}`;
        }

        function clearChangeIndicators() {
            ['totalMessagesChange', 'uniqueUsersChange', 'avgSessionLengthChange', 'activityPeriodChange'].forEach(id => {
                const element = document.getElementById(id);
                element.textContent = '';
                element.className = 'stat-change neutral';
            });
        }

        // グラフ作成
        function createCharts(data) {
            createTimeSeriesChart(data);
            createHeatmapChart(data);
            createPlatformChart(data);
            createSessionChart(data);
        }

        // 時系列グラフ
        function createTimeSeriesChart(data) {
            const ctx = document.getElementById('timeSeriesChart');
            
            if (charts.timeSeries) {
                charts.timeSeries.destroy();
            }
            
            const dailyStats = {};
            data.forEach(row => {
                const date = new Date(row.utterance_date);
                if (!isNaN(date)) {
                    const dateKey = date.toISOString().split('T')[0];
                    dailyStats[dateKey] = (dailyStats[dateKey] || 0) + 1;
                }
            });
            
            const sortedDates = Object.keys(dailyStats).sort();
            const values = sortedDates.map(date => dailyStats[date]);
            
            charts.timeSeries = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates.map(date => new Date(date).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'メッセージ数',
                        data: values,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // ヒートマップ（簡易版）
        function createHeatmapChart(data) {
            const ctx = document.getElementById('heatmapChart');
            
            if (charts.heatmap) {
                charts.heatmap.destroy();
            }
            
            const hourlyStats = {};
            for (let h = 0; h < 24; h++) {
                hourlyStats[h] = 0;
            }
            
            data.forEach(row => {
                const date = new Date(row.utterance_date);
                if (!isNaN(date)) {
                    const hour = date.getHours();
                    hourlyStats[hour]++;
                }
            });
            
            const hours = Object.keys(hourlyStats);
            const values = hours.map(h => hourlyStats[h]);
            
            charts.heatmap = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours.map(h => `${h}時`),
                    datasets: [{
                        label: 'メッセージ数',
                        data: values,
                        backgroundColor: values.map(v => {
                            const intensity = Math.max(...values) > 0 ? v / Math.max(...values) : 0;
                            return `rgba(16, 185, 129, ${0.3 + intensity * 0.7})`;
                        }),
                        borderColor: '#10b981',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // プラットフォームグラフ
        function createPlatformChart(data) {
            const ctx = document.getElementById('platformChart');
            
            if (charts.platform) {
                charts.platform.destroy();
            }
            
            const platformStats = {};
            data.forEach(row => {
                const platform = row.platform || 'unknown';
                platformStats[platform] = (platformStats[platform] || 0) + 1;
            });
            
            const labels = Object.keys(platformStats);
            const values = Object.values(platformStats);
            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'];
            
            charts.platform = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // セッション分布グラフ
        function createSessionChart(data) {
            const ctx = document.getElementById('sessionChart');
            
            if (charts.session) {
                charts.session.destroy();
            }
            
            const sessions = {};
            data.forEach(row => {
                if (row.session_id) {
                    sessions[row.session_id] = (sessions[row.session_id] || 0) + 1;
                }
            });
            
            const sessionLengths = Object.values(sessions);
            const distribution = {};
            
            sessionLengths.forEach(length => {
                let category;
                if (length === 1) category = '1メッセージ';
                else if (length <= 3) category = '2-3メッセージ';
                else if (length <= 5) category = '4-5メッセージ';
                else if (length <= 10) category = '6-10メッセージ';
                else category = '11+メッセージ';
                
                distribution[category] = (distribution[category] || 0) + 1;
            });
            
            const labels = ['1メッセージ', '2-3メッセージ', '4-5メッセージ', '6-10メッセージ', '11+メッセージ'];
            const values = labels.map(label => distribution[label] || 0);
            
            charts.session = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'セッション数',
                        data: values,
                        backgroundColor: '#3b82f6',
                        borderColor: '#2563eb',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // 期間比較
        function comparePeriods() {
            if (!currentData) {
                showError('データが読み込まれていません');
                return;
            }
            
            const startDate1 = new Date(document.getElementById('startDate1').value);
            const endDate1 = new Date(document.getElementById('endDate1').value);
            const startDate2 = new Date(document.getElementById('startDate2').value);
            const endDate2 = new Date(document.getElementById('endDate2').value);
            
            if (isNaN(startDate1) || isNaN(endDate1) || isNaN(startDate2) || isNaN(endDate2)) {
                showError('すべての日付を入力してください');
                return;
            }
            
            if (startDate1 >= endDate1 || startDate2 >= endDate2) {
                showError('開始日は終了日より前に設定してください');
                return;
            }
            
            showLoading(true);
            
            // 非同期処理でローディングが確実に表示されるようにする
            setTimeout(() => {
                try {
                    period1Data = filterDataByPeriod(currentData, startDate1, endDate1);
                    period2Data = filterDataByPeriod(currentData, startDate2, endDate2);
                    
                    const stats1 = calculateStats(period1Data);
                    const stats2 = calculateStats(period2Data);
                    
                    updateStatsDisplay(stats1, stats2);
                    createComparisonCharts(period1Data, period2Data);
                    
                    // 会話内容分析は期間1のデータで実行
                    analyzeContent(period1Data);
                    
                    showLoading(false);
                    showSuccess(`期間比較を実行しました（期間1: ${period1Data.length}件、期間2: ${period2Data.length}件）`);
                    
                } catch (error) {
                    console.error('期間比較エラー:', error);
                    showLoading(false);
                    showError('期間比較中にエラーが発生しました');
                }
            }, 100);
        }

        // 期間でデータフィルタ
        function filterDataByPeriod(data, startDate, endDate) {
            return data.filter(row => {
                const date = new Date(row.utterance_date);
                return !isNaN(date) && date >= startDate && date <= endDate;
            });
        }

        // 比較グラフ作成
        function createComparisonCharts(data1, data2) {
            createComparisonTimeSeriesChart(data1, data2);
            createComparisonPlatformChart(data1, data2);
        }

        // 比較時系列グラフ
        function createComparisonTimeSeriesChart(data1, data2) {
            const ctx = document.getElementById('timeSeriesChart');
            
            if (charts.timeSeries) {
                charts.timeSeries.destroy();
            }
            
            const getDailyStats = (data) => {
                const stats = {};
                data.forEach(row => {
                    const date = new Date(row.utterance_date);
                    if (!isNaN(date)) {
                        const dateKey = date.toISOString().split('T')[0];
                        stats[dateKey] = (stats[dateKey] || 0) + 1;
                    }
                });
                return stats;
            };
            
            const dailyStats1 = getDailyStats(data1);
            const dailyStats2 = getDailyStats(data2);
            
            const allDates = [...new Set([...Object.keys(dailyStats1), ...Object.keys(dailyStats2)])].sort();
            
            charts.timeSeries = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allDates.map(date => new Date(date).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: '期間1',
                        data: allDates.map(date => dailyStats1[date] || 0),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    }, {
                        label: '期間2',
                        data: allDates.map(date => dailyStats2[date] || 0),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // 比較プラットフォームグラフ
        function createComparisonPlatformChart(data1, data2) {
            const ctx = document.getElementById('platformChart');
            
            if (charts.platform) {
                charts.platform.destroy();
            }
            
            const getPlatformStats = (data) => {
                const stats = {};
                data.forEach(row => {
                    const platform = row.platform || 'unknown';
                    stats[platform] = (stats[platform] || 0) + 1;
                });
                return stats;
            };
            
            const platformStats1 = getPlatformStats(data1);
            const platformStats2 = getPlatformStats(data2);
            
            const allPlatforms = [...new Set([...Object.keys(platformStats1), ...Object.keys(platformStats2)])];
            
            charts.platform = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: allPlatforms,
                    datasets: [{
                        label: '期間1',
                        data: allPlatforms.map(platform => platformStats1[platform] || 0),
                        backgroundColor: '#10b981',
                        borderColor: '#059669',
                        borderWidth: 1
                    }, {
                        label: '期間2',
                        data: allPlatforms.map(platform => platformStats2[platform] || 0),
                        backgroundColor: '#3b82f6',
                        borderColor: '#2563eb',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // CSVエクスポート
        function exportStats() {
            if (!currentData) {
                showError('エクスポートするデータがありません');
                return;
            }
            
            const stats = calculateStats(currentData);
            
            const csvData = [
                ['項目', '値'],
                ['総メッセージ数', stats.totalMessages],
                ['ユニークユーザー数', stats.uniqueUsers],
                ['平均セッション長', stats.avgSessionLength],
                ['活動期間', stats.activityPeriod],
                ['データ生成日時', new Date().toLocaleString('ja-JP')]
            ];
            
            downloadCSV(csvData, 'miibo_stats_' + getCurrentTimestamp() + '.csv');
        }

        function exportTimeSeries() {
            if (!currentData) {
                showError('エクスポートするデータがありません');
                return;
            }
            
            const dailyStats = {};
            currentData.forEach(row => {
                const date = new Date(row.utterance_date);
                if (!isNaN(date)) {
                    const dateKey = date.toISOString().split('T')[0];
                    dailyStats[dateKey] = (dailyStats[dateKey] || 0) + 1;
                }
            });
            
            const csvData = [['日付', 'メッセージ数']];
            Object.keys(dailyStats).sort().forEach(date => {
                csvData.push([date, dailyStats[date]]);
            });
            
            downloadCSV(csvData, 'miibo_timeseries_' + getCurrentTimestamp() + '.csv');
        }

        function exportContentAnalysis() {
            if (!currentData) {
                showError('エクスポートするデータがありません');
                return;
            }
            
            // 発話頻度データ
            const utterances = currentData.map(row => row.utterance).filter(Boolean);
            const frequency = {};
            
            utterances.forEach(utterance => {
                const cleaned = utterance.trim();
                if (cleaned) {
                    frequency[cleaned] = (frequency[cleaned] || 0) + 1;
                }
            });
            
            const sortedUtterances = Object.entries(frequency)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 20);
            
            // CSVデータ作成
            const csvData = [
                ['発話内容分析'],
                ['順位', '発話内容', '出現回数'],
                ...sortedUtterances.map(([utterance, count], index) => [index + 1, utterance, count]),
                [''],
                ['基本統計'],
                ['項目', '値'],
                ['総発話数', utterances.length],
                ['ユニーク発話数', Object.keys(frequency).length],
                ['平均文字数', utterances.length > 0 ? (utterances.reduce((sum, u) => sum + u.length, 0) / utterances.length).toFixed(1) : 0],
                [''],
                ['データ生成日時', new Date().toLocaleString('ja-JP')]
            ];
            
            downloadCSV(csvData, 'miibo_content_analysis_' + getCurrentTimestamp() + '.csv');
        }

        function downloadCSV(data, filename) {
            const csv = data.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSuccess(`${filename} をダウンロードしました`);
            }
        }

        // 初期表示にリセット
        function resetToInitialView() {
            if (!currentData) {
                showError('リセットするデータがありません');
                return;
            }
            
            showLoading(true);
            
            try {
                // 期間比較データをクリア
                period1Data = null;
                period2Data = null;
                
                // 期間選択の日付を初期値に戻す
                resetPeriodDates();
                
                // 統計表示を元に戻す
                const stats = calculateStats(currentData);
                updateStatsDisplay(stats); // 比較データなしで更新
                
                // グラフを初期状態に戻す
                createCharts(currentData);
                
                // 会話内容分析も初期状態に戻す
                analyzeContent(currentData);
                
                showLoading(false);
                showSuccess('初期表示に戻しました（期間設定もリセット）');
                
            } catch (error) {
                console.error('リセットエラー:', error);
                showLoading(false);
                showError('リセット中にエラーが発生しました');
            }
        }

        // 期間日付をリセット
        function resetPeriodDates() {
            if (window.initialPeriodDates) {
                document.getElementById('startDate1').value = window.initialPeriodDates.startDate1;
                document.getElementById('endDate1').value = window.initialPeriodDates.endDate1;
                document.getElementById('startDate2').value = window.initialPeriodDates.startDate2;
                document.getElementById('endDate2').value = window.initialPeriodDates.endDate2;
            }
        }

        function getCurrentTimestamp() {
            return new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
        }

        // UI制御関数
        function showLoading(show) {
            const loadingEl = document.getElementById('loading');
            if (loadingEl) {
                if (show) {
                    loadingEl.classList.add('show');
                } else {
                    loadingEl.classList.remove('show');
                }
            }
        }

        function showError(message) {
            // まずローディングを確実に非表示
            showLoading(false);
            hideProgress();
            
            const errorEl = document.getElementById('errorMessage');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => {
                    errorEl.style.display = 'none';
                }, 5000);
            }
        }

        function showSuccess(message) {
            // まずローディングを確実に非表示
            showLoading(false);
            hideProgress();
            
            const successEl = document.getElementById('successMessage');
            if (successEl) {
                successEl.textContent = message;
                successEl.style.display = 'block';
                setTimeout(() => {
                    successEl.style.display = 'none';
                }, 3000);
            }
        }

        function updateFileInfo(filename, recordCount) {
            document.getElementById('fileInfo').textContent = 
                `ファイル: ${filename} (${recordCount.toLocaleString()}件のレコード)`;
        }

        function showSections() {
            // ローディングを確実に非表示
            showLoading(false);
            hideProgress();
            
            document.getElementById('noData').style.display = 'none';
            document.getElementById('statsGrid').style.display = 'grid';
            document.getElementById('chartsGrid').style.display = 'grid';
            document.getElementById('contentAnalysisSection').style.display = 'block';
            document.getElementById('exportSection').style.display = 'block';
        }

        // 会話内容分析
        function analyzeContent(data) {
            analyzeUtteranceFrequency(data);
            analyzeKeywords(data);
            analyzeBehaviorPatterns(data);
            analyzeTextStats(data);
            analyzeEmotions(data);
        }

        // 発話頻度分析
        function analyzeUtteranceFrequency(data) {
            const utterances = data.map(row => row.utterance).filter(Boolean);
            const frequency = {};
            
            utterances.forEach(utterance => {
                const cleaned = utterance.trim();
                if (cleaned) {
                    frequency[cleaned] = (frequency[cleaned] || 0) + 1;
                }
            });
            
            const sorted = Object.entries(frequency)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            const rankingList = document.getElementById('utteranceRanking');
            rankingList.innerHTML = '';
            
            sorted.forEach(([utterance, count], index) => {
                const item = document.createElement('div');
                item.className = 'ranking-item';
                
                item.innerHTML = `
                    <div class="ranking-number ${index < 3 ? 'top3' : ''}">${index + 1}</div>
                    <div class="ranking-text">"${utterance}"</div>
                    <div class="ranking-count">${count}回</div>
                `;
                
                rankingList.appendChild(item);
            });
        }

        // キーワード分析
        function analyzeKeywords(data) {
            const utterances = data.map(row => row.utterance).filter(Boolean);
            const keywords = {};
            
            // 日本語のキーワード抽出（簡易版）
            const keywordPatterns = [
                'ありがとう', 'こんにちは', 'すみません', 'お願い', '教えて',
                'わからない', '困っている', '不安', '悩み', '相談',
                '質問', '問題', 'トラブル', 'エラー', 'できない',
                '方法', 'やり方', '手順', '設定', '使い方'
            ];
            
            utterances.forEach(utterance => {
                keywordPatterns.forEach(keyword => {
                    if (utterance.includes(keyword)) {
                        keywords[keyword] = (keywords[keyword] || 0) + 1;
                    }
                });
            });
            
            const sortedKeywords = Object.entries(keywords)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8);
            
            if (sortedKeywords.length > 0) {
                createKeywordChart(sortedKeywords);
            }
        }

        // キーワードチャート作成
        function createKeywordChart(keywordData) {
            const ctx = document.getElementById('keywordChart');
            
            if (charts.keyword) {
                charts.keyword.destroy();
            }
            
            const labels = keywordData.map(([keyword]) => keyword);
            const values = keywordData.map(([, count]) => count);
            
            charts.keyword = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '出現回数',
                        data: values,
                        backgroundColor: '#10b981',
                        borderColor: '#059669',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // ユーザー行動パターン分析
        function analyzeBehaviorPatterns(data) {
            const total = data.length;
            const patterns = {
                '挨拶': 0,
                '質問': 0,
                '感謝': 0,
                '相談': 0,
                'その他': 0
            };
            
            data.forEach(row => {
                const utterance = row.utterance || '';
                
                if (utterance.match(/(こんにちは|こんばんは|おはよう|初めまして)/)) {
                    patterns['挨拶']++;
                } else if (utterance.match(/(？|\?|なに|どう|いつ|どこ|誰|何)/)) {
                    patterns['質問']++;
                } else if (utterance.match(/(ありがとう|感謝|助かり)/)) {
                    patterns['感謝']++;
                } else if (utterance.match(/(困っ|悩み|不安|相談|問題)/)) {
                    patterns['相談']++;
                } else {
                    patterns['その他']++;
                }
            });
            
            createBehaviorChart(patterns);
        }

        // 行動パターンチャート作成
        function createBehaviorChart(patterns) {
            const ctx = document.getElementById('behaviorChart');
            
            if (charts.behavior) {
                charts.behavior.destroy();
            }
            
            const labels = Object.keys(patterns);
            const values = Object.values(patterns);
            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'];
            
            charts.behavior = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // テキスト統計分析
        function analyzeTextStats(data) {
            const utterances = data.map(row => row.utterance).filter(Boolean);
            const lengths = utterances.map(u => u.length);
            
            const stats = {
                total: utterances.length,
                avgLength: lengths.length > 0 ? (lengths.reduce((a, b) => a + b, 0) / lengths.length).toFixed(1) : 0,
                minLength: lengths.length > 0 ? Math.min(...lengths) : 0,
                maxLength: lengths.length > 0 ? Math.max(...lengths) : 0
            };
            
            const textStatsContainer = document.getElementById('textStats');
            textStatsContainer.innerHTML = `
                <div class="text-stat-item">
                    <div class="text-stat-value">${stats.total}</div>
                    <div class="text-stat-label">総発話数</div>
                </div>
                <div class="text-stat-item">
                    <div class="text-stat-value">${stats.avgLength}</div>
                    <div class="text-stat-label">平均文字数</div>
                </div>
                <div class="text-stat-item">
                    <div class="text-stat-value">${stats.minLength}</div>
                    <div class="text-stat-label">最短文字数</div>
                </div>
                <div class="text-stat-item">
                    <div class="text-stat-value">${stats.maxLength}</div>
                    <div class="text-stat-label">最長文字数</div>
                </div>
            `;
        }

        // 感情・意図分析
        function analyzeEmotions(data) {
            const total = data.length;
            const emotions = {
                positive: { count: 0, icon: '😊', label: 'ポジティブ', keywords: ['ありがとう', '嬉しい', '助かり', '良い', '素晴らしい'] },
                question: { count: 0, icon: '❓', label: '質問・疑問', keywords: ['？', '?', 'どう', 'なに', '教えて'] },
                concern: { count: 0, icon: '😟', label: '不安・相談', keywords: ['不安', '困', '悩み', '心配', '問題'] },
                greeting: { count: 0, icon: '👋', label: '挨拶', keywords: ['こんにちは', 'こんばんは', 'おはよう', '初めまして'] },
                neutral: { count: 0, icon: '😐', label: '中立・その他', keywords: [] }
            };
            
            data.forEach(row => {
                const utterance = row.utterance || '';
                let categorized = false;
                
                for (const [key, emotion] of Object.entries(emotions)) {
                    if (key === 'neutral') continue;
                    
                    if (emotion.keywords.some(keyword => utterance.includes(keyword))) {
                        emotion.count++;
                        categorized = true;
                        break;
                    }
                }
                
                if (!categorized) {
                    emotions.neutral.count++;
                }
            });
            
            const emotionContainer = document.getElementById('emotionAnalysis');
            emotionContainer.innerHTML = '';
            
            Object.entries(emotions).forEach(([key, emotion]) => {
                const percentage = total > 0 ? ((emotion.count / total) * 100).toFixed(1) : 0;
                
                const item = document.createElement('div');
                item.className = 'emotion-item';
                
                item.innerHTML = `
                    <span class="emotion-icon">${emotion.icon}</span>
                    <div class="emotion-label">${emotion.label}</div>
                    <div class="emotion-count">${emotion.count}</div>
                    <div class="emotion-percentage">${percentage}%</div>
                `;
                
                emotionContainer.appendChild(item);
            });
        }
    </script>
</body>
</html>